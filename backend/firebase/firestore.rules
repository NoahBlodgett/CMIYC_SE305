rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }
    function isOwner(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }
    function hasOnlyKeys(allowed) {
      return request.resource.data.keys().hasOnly(allowed);
    }
    function hasKey(k) {
      return request.resource.data.keys().hasAny([k]);
    }

    // Validation helpers (only enforce if the field is present)
    function validName() {
      return !hasKey('name') || (request.resource.data.name is string && request.resource.data.name.size() > 0 && request.resource.data.name.size() <= 100);
    }
    function validAge() {
      return !hasKey('age') || (request.resource.data.age is int && request.resource.data.age > 0 && request.resource.data.age < 130);
    }
    function validGender() {
      return !hasKey('gender') || (request.resource.data.gender in ['male','female']);
    }
    function validEmail(uid) {
      return !hasKey('email') || (request.resource.data.email is string && request.resource.data.email == request.auth.token.email);
    }
    function validHeight() {
      return !hasKey('height') || (request.resource.data.height is number && request.resource.data.height > 0 && request.resource.data.height < 300);
    }
    function validWeight() {
      return !hasKey('weight') || (request.resource.data.weight is number && request.resource.data.weight > 0 && request.resource.data.weight < 1000);
    }
    function validActivity() {
      return !hasKey('activity_level') || (request.resource.data.activity_level is number && request.resource.data.activity_level >= 0 && request.resource.data.activity_level <= 5);
    }
    function validAllergies() {
      return !hasKey('allergies') || (request.resource.data.allergies is string);
    }
    function validOnboardingFlag() {
      return !hasKey('onboarding_completed') || (request.resource.data.onboarding_completed is bool);
    }

    function validWorkoutDuration() {
      return request.resource.data.duration is int && request.resource.data.duration > 0 && request.resource.data.duration <= 600;
    }

    function validWorkoutCalories() {
      return request.resource.data.cals_burned is number && request.resource.data.cals_burned > 0;
    }

    function validWorkoutTimestamp() {
      return request.resource.data.date is timestamp;
    }

    function validWorkoutWeight() {
      return request.resource.data.weight_lifted is number && request.resource.data.weight_lifted >= 0;
    }

    function validMovement() {
      return !hasKey('movement') || (
        request.resource.data.movement is map &&
        request.resource.data.movement.name is string && request.resource.data.movement.name.size() > 0 &&
        request.resource.data.movement.muscle_group is string && request.resource.data.movement.muscle_group.size() > 0 &&
        request.resource.data.movement.sets is int && request.resource.data.movement.sets > 0 &&
        (!request.resource.data.movement.keys().hasAny(['reps']) || (request.resource.data.movement.reps is int && request.resource.data.movement.reps > 0))
      );
    }

    // Allow users to read/write their own user document
    match /users/{userId} {
      allow read, write: if isOwner(userId);
    }

    match /workouts/{workoutId} {
      allow create: if isSignedIn() &&
        request.resource.data.user_id == request.auth.uid &&
        validWorkoutDuration() &&
        validWorkoutCalories() &&
        validWorkoutTimestamp() &&
        validWorkoutWeight() &&
        validMovement();

      allow read: if isSignedIn() && resource.data.user_id == request.auth.uid;

      allow update, delete: if isSignedIn() && resource.data.user_id == request.auth.uid &&
        (request.resource == null || (
          (!hasKey('user_id') || request.resource.data.user_id == resource.data.user_id) &&
          (!hasKey('duration') || validWorkoutDuration()) &&
          (!hasKey('cals_burned') || validWorkoutCalories()) &&
          (!hasKey('date') || validWorkoutTimestamp()) &&
          (!hasKey('weight_lifted') || validWorkoutWeight()) &&
          validMovement()
        ));
    }

    // Deny everything else by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}