rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }
    function isOwner(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }
    function hasOnlyKeys(allowed) {
      return request.resource.data.keys().hasOnly(allowed);
    }
    function hasKey(k) {
      return request.resource.data.keys().hasAny([k]);
    }

    // Validation helpers (only enforce if the field is present)
    function validName() {
      return !hasKey('name') || (request.resource.data.name is string && request.resource.data.name.size() > 0 && request.resource.data.name.size() <= 100);
    }
    function validAge() {
      return !hasKey('age') || (request.resource.data.age is int && request.resource.data.age > 0 && request.resource.data.age < 130);
    }
    function validGender() {
      return !hasKey('gender') || (request.resource.data.gender in ['male','female']);
    }
    function validEmail(uid) {
      return !hasKey('email') || (request.resource.data.email is string && request.resource.data.email == request.auth.token.email);
    }
    function validHeight() {
      return !hasKey('height') || (request.resource.data.height is number && request.resource.data.height > 0 && request.resource.data.height < 300);
    }
    function validWeight() {
      return !hasKey('weight') || (request.resource.data.weight is number && request.resource.data.weight > 0 && request.resource.data.weight < 1000);
    }
    function validActivity() {
      return !hasKey('activity_level') || (request.resource.data.activity_level is number && request.resource.data.activity_level >= 0 && request.resource.data.activity_level <= 5);
    }
    function validAllergies() {
      return !hasKey('allergies') || (request.resource.data.allergies is string);
    }
    function validOnboardingFlag() {
      return !hasKey('onboarding_completed') || (request.resource.data.onboarding_completed is bool);
    }

    function workoutDurationValue(map) {
      return map.keys().hasAny(['duration'])
        ? map.duration
        : (map.keys().hasAny(['duration_minutes']) ? map.duration_minutes : null);
    }

    function validWorkoutDuration(map) {
      let value = workoutDurationValue(map);
      return value is int && value > 0 && value <= 600;
    }

    function workoutCaloriesValue(map) {
      return map.keys().hasAny(['cals_burned'])
        ? map.cals_burned
        : (map.keys().hasAny(['calories_burned']) ? map.calories_burned : null);
    }

    function validWorkoutCalories(map) {
      let value = workoutCaloriesValue(map);
      return value is number && value > 0;
    }

    function validWorkoutTimestamp(map) {
      return map.keys().hasAny(['date']) && map.date is timestamp;
    }

    function validWorkoutWeight(map) {
      return !map.keys().hasAny(['weight_lifted']) || (map.weight_lifted is number && map.weight_lifted >= 0);
    }

    function validMovement(map) {
      return !map.keys().hasAny(['movement']) || (
        map.movement is map &&
        map.movement.name is string && map.movement.name.size() > 0 &&
        map.movement.muscle_group is string && map.movement.muscle_group.size() > 0 &&
        map.movement.sets is int && map.movement.sets > 0 &&
        (!map.movement.keys().hasAny(['reps']) || (map.movement.reps is int && map.movement.reps > 0))
      );
    }

    function validWorkoutName(map) {
      return !map.keys().hasAny(['name']) || (map.name is string && map.name.size() > 0 && map.name.size() <= 100);
    }

    function validWorkoutType(map) {
      return !map.keys().hasAny(['type']) || (map.type in ['timed', 'strength']);
    }

    function validActivityKey(map) {
      return !map.keys().hasAny(['activity_key']) || (map.activity_key is string && map.activity_key.size() > 0 && map.activity_key.size() <= 120);
    }

    function validWorkoutSets(map) {
      return !map.keys().hasAny(['sets']) || (map.sets is list && map.sets.size() <= 100);
    }

    // Allow users to read/write their own user document
    match /users/{userId} {
      allow read, write: if isOwner(userId);
    }

    match /workouts/{workoutId} {
      allow create: if isSignedIn() &&
        request.resource.data.user_id == request.auth.uid &&
        validWorkoutDuration(request.resource.data) &&
        validWorkoutCalories(request.resource.data) &&
        validWorkoutTimestamp(request.resource.data) &&
        validWorkoutWeight(request.resource.data) &&
        validMovement(request.resource.data) &&
        validWorkoutName(request.resource.data) &&
        validWorkoutType(request.resource.data) &&
        validActivityKey(request.resource.data) &&
        validWorkoutSets(request.resource.data);

      allow read: if isSignedIn() && resource.data.user_id == request.auth.uid;

      allow update, delete: if isSignedIn() && resource.data.user_id == request.auth.uid &&
        (request.resource == null || (
          (!request.resource.data.keys().hasAny(['user_id']) || request.resource.data.user_id == resource.data.user_id) &&
          (!request.resource.data.keys().hasAny(['duration', 'duration_minutes']) || validWorkoutDuration(request.resource.data)) &&
          (!request.resource.data.keys().hasAny(['cals_burned', 'calories_burned']) || validWorkoutCalories(request.resource.data)) &&
          (!request.resource.data.keys().hasAny(['date']) || validWorkoutTimestamp(request.resource.data)) &&
          (!request.resource.data.keys().hasAny(['weight_lifted']) || validWorkoutWeight(request.resource.data)) &&
          validMovement(request.resource.data) &&
          validWorkoutName(request.resource.data) &&
          validWorkoutType(request.resource.data) &&
          validActivityKey(request.resource.data) &&
          validWorkoutSets(request.resource.data)
        ));
    }

    // Deny everything else by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}