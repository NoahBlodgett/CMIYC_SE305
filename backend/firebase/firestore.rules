rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }
    function isOwner(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }
    function hasOnlyKeys(allowed) {
      return request.resource.data.keys().hasOnly(allowed);
    }
    function hasKey(k) {
      return request.resource.data.keys().hasAny([k]);
    }

    // Validation helpers (only enforce if the field is present)
    function validName() {
      return !hasKey('name') || (request.resource.data.name is string && request.resource.data.name.size() > 0 && request.resource.data.name.size() <= 100);
    }
    function validAge() {
      return !hasKey('age') || (request.resource.data.age is int && request.resource.data.age > 0 && request.resource.data.age < 130);
    }
    function validGender() {
      return !hasKey('gender') || (request.resource.data.gender in ['male','female']);
    }
    function validEmail(uid) {
      return !hasKey('email') || (request.resource.data.email is string && request.resource.data.email == request.auth.token.email);
    }
    function validHeight() {
      return !hasKey('height') || (request.resource.data.height is number && request.resource.data.height > 0 && request.resource.data.height < 300);
    }
    function validWeight() {
      return !hasKey('weight') || (request.resource.data.weight is number && request.resource.data.weight > 0 && request.resource.data.weight < 1000);
    }
    function validActivity() {
      return !hasKey('activity_level') || (request.resource.data.activity_level is number && request.resource.data.activity_level >= 0 && request.resource.data.activity_level <= 5);
    }
    function validAllergies() {
      return !hasKey('allergies') || (request.resource.data.allergies is string);
    }
    function validOnboardingFlag() {
      return !hasKey('onboarding_completed') || (request.resource.data.onboarding_completed is bool);
    }

    // Users can read/write only their own user doc (with basic validation)
    match /users/{uid} {
      allow read: if isOwner(uid);
      allow create, update: if isOwner(uid)
        && validName()
        && validAge()
        && validGender()
        && validEmail(uid)
        && validHeight()
        && validWeight()
        && validActivity()
        && validAllergies()
        && validOnboardingFlag();
      allow delete: if isOwner(uid);

      // Nutrition entries subcollection for a given user
      match /nutrition_entries/{entryId} {
        allow read: if isOwner(uid);
        allow create: if isOwner(uid)
          && request.resource.data.calories is number
          && request.resource.data.protein is number
          && request.resource.data.carbs is number
          && request.resource.data.fat is number
          && request.resource.data.mealType is string
          && request.resource.data.day is string
          && request.resource.data.timestamp is string;
        allow update: if isOwner(uid);
        allow delete: if isOwner(uid);
      }
    }

    // Deny everything else by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}